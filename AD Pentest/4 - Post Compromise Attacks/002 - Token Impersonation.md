### What is Token
![[Pasted image 20210715170212.png]]

### What is Token Impersonation Attack
Token Impersonation is a way of impersonating a user access token, allowing you to effectively take over the user without even needing to know the userâ€™s password

We are going to use delegate tokens for this attack. First get a shell on a user on the domain. Open metasploit and use `exploit/windows/smb/psexec`

![[Pasted image 20210727094259.png]]

Now let's see the uid of the user and system info. Type `getuid` for getting user id and `sysinfo` for system information

![[Pasted image 20210727094421.png]]

Now load the incognito module for token impersonation. Type `load incognito` for loading incognito module and `list_token -u` for loading user tokens. You can also do `list_token -g` for loading groups tokens

We can see that `MARVEL\Administrator` token is available to us

![[Pasted image 20210727094732.png]]

Lets impersonate to `MARVEL\Administrator`. To do this type `impersonate_token marvel\\administrator` , the `\\` is for escaping the slash

Now you are `MARVEL\Administrator`

![[Pasted image 20210727095039.png]]

Now if you want to go back to the user you are logged in type `rev2self` for going back to user you were logged in as before performing impersonation attack

### Defenses
![[Pasted image 20210727095445.png]]